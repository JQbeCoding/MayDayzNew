<!DOCTYPE html>
<html lang="en">

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PN5PZ1Z3KG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-PN5PZ1Z3KG");
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Maydayz - Login</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="../css/login.css" />
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="../css/loading.css" />
  <style>
    /* Basic Modal Styling - You should move this to login.css */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #333;
      margin: 5% auto;
      padding: 30px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 8px;
      text-align: center;
      color: white;
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #fff;
    }

    .modal-content input[type="tel"] {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 5px;
      border: 1px solid #555;
      background-color: #444;
      color: white;
    }

    .modal-content button {
      background-color: red;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    .modal-content button:hover {
      background-color: #45a049;
    }
  </style>
</head>

<body>
  <div id="loading-screen">
    <div class="loading-spinner"></div>
    <p id="loadingText">Loading...</p>
  </div>

  <div id="Smalltabs">
    <a href="../../Index.html">
      <img src="/SRC/ASSETS/IMAGES/Maydayz-LOGO.svg" width="200px" height="200px" alt="Maydayz Logo" />
    </a>

    <div class="login-container">
      <form id="loginFormCustom">
        <h2>Log In</h2>
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required /><br /><br />

        <button type="submit">Log In</button>
      </form>

      <div
        style="display: flex; flex-direction: column; align-items: center; text-transform: uppercase; margin-top: 20px;">
        <p class="transparency">Or log in with Google</p>
      </div>

      <style>
        .signup-link:hover {
          color: yellow;
        }
      </style>

      <div id="g_id_onload" data-client_id="313885668082-p6qra4vln2kcbms9lq0bbu57128fqmkp.apps.googleusercontent.com"
        data-context="signin" data-ux_mode="popup" data-login_uri="http://localhost:5500" data-auto_prompt="false"
        data-callback="handleSignInWithGoogle">
      </div>

      <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_black" data-text="signin_with"
        data-size="large" data-logo_alignment="left">
      </div>

      <p class="transparency">
        Maydayz will use the provided information for promotional purposes only.
        <br />
        Signing up confirms you will receive text and email updates from
        Maydayz.
        <br />
        For any questions, call 980-499-8399.
        <br />
        <br />
        WE SMOKED OUT!!
      </p>
      <div class="parent">
        <a id="privacy" onclick="window.open('privacy-policy.html')">Privacy Policy</a>
      </div>
    </div>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
      const SUPABASE_URL = 'https://iacgeepjpcpfwyewaeyo.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhY2dlZXBqcGNwZnd5ZXdhZXlvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MTY2Mzg0NywiZXhwIjoyMDU3MjM5ODQ3fQ.flSRyAdS93fPx7ct1wW38u6F8XARRtfW-Zk9vRDC230';

      window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      let currentNewUserId = null; // To store the ID of the new user for the phone number update

      async function submitPhoneNumber() {
        const phoneNumberInput = document.getElementById('phoneNumberInput');
        const phoneNumber = "+1" + phoneNumberInput.value.trim();

        if (!phoneNumber) {
          alert("Please enter your phone number.");
          return;
        }

        if (!currentNewUserId) {
          alert("Error: User ID not found. Please try logging in again.");
          hidePhoneNumberModal();
          return;
        }

        try {
          const { data, error } = await window.supabase
            .from('MaydayzCustomers')
            .update({ phoneNumber: phoneNumber })
            .eq('id', currentNewUserId);

          if (error) {
            console.error("Error updating phone number:", error.message);
            alert("Failed to save phone number: " + error.message);
          } else {
            console.log("Phone number updated successfully:", data);
            alert("Phone number saved! Redirecting to home.");
            hidePhoneNumberModal();
            window.location.href = "/Index.html";
          }
        } catch (updateError) {
          console.error("Unexpected error during phone number update:", updateError.message);
          alert("An unexpected error occurred. Please try again.");
        }
      }

      function showPhoneNumberModal() {
        document.getElementById('phoneNumberModal').style.display = 'block';
        document.getElementById('phoneNumberInput').focus();
      }

      function hidePhoneNumberModal() {
        document.getElementById('phoneNumberModal').style.display = 'none';
        document.getElementById('phoneNumberInput').value = ''; // Clear input
        currentNewUserId = null; // Clear stored ID
      }


      async function handleNewGoogleUser(user) {
        console.log("New Google user detected. Creating profile...");
        try {
          const userName = user.user_metadata?.full_name || user.user_metadata?.name || null;
          const userEmail = user.email;
          const userPhoneNumber = '';

          const customerData = {
            id: user.id,
            name: userName,
            email: userEmail,
            phoneNumber: userPhoneNumber
          };

          const { data, error } = await window.supabase
            .from('MaydayzCustomers')
            .insert([customerData]);

          if (error) {
            console.error("Error creating new profile for Google user:", error.message);
            if (error.code === '23505') {
              alert("It looks like a profile already exists for this user. Please try logging in.");
            } else {
              alert("Failed to create user profile. Please try again: " + error.message);
            }
          } else {
            console.log("New user profile created successfully:", data);
            currentNewUserId = user.id;
            showPhoneNumberModal();

          }
        } catch (insertError) {
          console.error("Unexpected error during new profile creation:", insertError.message);
          alert("An unexpected error occurred during profile setup.");
        }
      }

      async function verifyGoogleEmailInDatabase() {
        try {
          const { data: { user } } = await window.supabase.auth.getUser();

          if (user) {
            const userEmail = user.email;

            if (!userEmail) {
              console.warn("User email not available from Supabase authentication. Cannot verify in database.");
              return { exists: false, error: "Email not found in user session." };
            }

            const { data: existingProfiles, error } = await window.supabase
              .from('MaydayzCustomers')
              .select('id, email')
              .eq('email', userEmail);

            if (error) {
              console.error("Error checking email in database:", error.message);
              return { exists: false, error: error.message };
            }

            if (existingProfiles && existingProfiles.length > 0) {
              console.log(`Email '${userEmail}' found in the database.`);
              return { exists: true, profile: existingProfiles[0] };
            } else {
              console.log(`Email '${userEmail}' NOT found in the database. This might be a new user.`);
              return { exists: false, user: user };
            }

          } else {
            console.log("No authenticated user found. User needs to sign in first.");
            return { exists: false, error: "No authenticated user." };
          }

        } catch (error) {
          console.error("An unexpected error occurred during email verification:", error.message);
          return { exists: false, error: error.message };
        }
      }

      async function handleSignInWithGoogle(response) {
        console.log("Google ID Token received.");

        const { data, error } = await window.supabase.auth.signInWithIdToken({
          provider: "google",
          token: response.credential,
        });

        if (error) {
          console.error("Supabase Google Sign-In Error:", error);
          alert("Google sign-in failed: " + error.message);
        } else {
          console.log("Supabase Google Sign-In Success:", data);
          alert("Signed in with Google successfully!");

          const verificationResult = await verifyGoogleEmailInDatabase();

          if (verificationResult.exists) {
            console.log("User already exists in MaydayzCustomers table. Welcome Back!");
            window.alert("Welcome Back!!");
            window.location.href = "/Index.html";
          } else {
            console.log("New user via Google sign-in. Creating a new profile entry.");
            if (verificationResult.user) {
              await handleNewGoogleUser(verificationResult.user);
            } else {
              console.error("Could not get user details after Google sign-in to create new profile.");
              alert("Sign-in successful, but an issue occurred setting up your profile. Please contact support.");
            }
          }
        }
      }

      const customLoginForm = document.getElementById("loginFormCustom");

      customLoginForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(customLoginForm);
        const formDataObject = Object.fromEntries(formData);

        if (!formDataObject.email) {
          alert("Please enter your email.");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:3000/login",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formDataObject),
            }
          );

          if (response.ok) {
            alert("Login successful!");
            window.location.href = "/Index.html";
          } else {
            const errorMessage = await response.text();
            console.error("Custom Login failed:", errorMessage);
            alert(`Login failed: ${errorMessage}`);
          }
        } catch (error) {
          console.error("Error during custom login:", error);
          alert("An error occurred during login. Please try again later.");
        }
      });
    </script>
    <script src="/src/js/loading.js"></script>
  </div>

  <div id="phoneNumberModal" class="modal">
    <div class="modal-content">
      <h3>WELCOME!! You appear new so please provide your phone numbe for updates!!!</h3>
      <input type="tel" id="phoneNumberInput" placeholder="Enter phone number" required>
      <p>Enter number without Dashes(-) or Parathenses</p>
      <button onclick="submitPhoneNumber()">Submit</button>
    </div>
  </div>
</body>

</html>